services:
  pg-status:
    image: pg-status:latest
    ports:
      - 8000:8000
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 6M
        reservations:
          cpus: "0.1"
          memory: 6M
    networks:
      - net
    restart: unless-stopped
    environment:
      - pg_status__connect_timeout=2
      - pg_status__hosts=pg-proxy-1,pg-proxy-2
      - pg_status__pg_database=postgres
      - pg_status__pg_password=postgres
      - pg_status__pg_user=postgres
      - pg_status__port=5432
      - pg_status__sleep=5

  postgres_master:
    build:
      context: ./master
    ports:
      - 5433:5432
    container_name: postgres_master
    networks:
      - net
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - REPLICATION_ROLE=master
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      retries: 10

  postgres_replica:
    build:
      context: ./replica
    ports:
      - 5434:5432
    container_name: postgres_replica
    depends_on:
      - postgres_master
    networks:
        - net
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - REPLICATION_ROLE=replica
      - MASTER_HOST=postgres_master
      - MASTER_USER=replicator
      - MASTER_PASSWORD=postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      retries: 10

  pg-proxy-1:
    build:
      context: ./haproxy-master
    container_name: pg-proxy-1
    ports:
      - "5435:5432"
    networks:
      - net
    depends_on:
      - postgres_master
      - postgres_replica
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'show info' | socat stdio /tmp/haproxy-master.sock || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  pg-proxy-2:
    build:
      context: ./haproxy-replica
    container_name: pg-proxy-2
    ports:
      - "5436:5432"
    networks:
      - net
    depends_on:
      - postgres_master
      - postgres_replica
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'show info' | socat stdio /tmp/haproxy-master.sock || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  net:
